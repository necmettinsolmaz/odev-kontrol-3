<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödev Takip Sistemi - Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
    	<script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
    <style>
        /* SAF CSS: Durum Butonu Stilleri */
        .status-cell { 
			margin: 0px;
            padding: 2px; 
            white-space: nowrap;
        }

        .status { 
            cursor: pointer; 
            border-radius: 6px; 
            padding: 12px 6px; /* Dikey padding rahatlatıldı */
            color: white; 
            transition: background-color 0.15s ease-in-out;
            font-weight: 500;
            font-size: 0.75rem; /* text-xs'e geri döndü */
            line-height: 1;
            width: 100%; 
            min-width: 5rem;
            display: flex;
            align-items: center;
            justify-content: center;
			/* YENİ: Emoji konumlandırma için */
			position: relative; 
        }

		/* YENİ: Boş Statü: Görünmez başlangıç durumu için */
		.status:empty {
			background-color: #f9f9f9; /* Hafif gri arka plan */
			color: #1f2937; /* Siyah metin */
			border: 1px solid #d1d5db; /* Hafif kenarlık */
			min-height: 2.25rem; /* Buton yüksekliğini korur */
			padding: 0;
			line-height: 2.25rem; /* Yüksekliği ortalamak için */
		}

			/* YENİ VE CANLI RENK PALETİ */
		/* Kırmızı - Yapmadı */
		.Yapmadı { background-color: #ef4444; } /* Kırmızı (Red 500) */
		.Yapmadı:hover { background-color: #dc2626; } 

		/* Turuncu/Sarı - Eksik */
		.Eksik { background-color: #f59e0b; } /* Turuncu (Amber 500) */
		.Eksik:hover { background-color: #d97706; } 

		/* Yeşil - Yaptı */
		.Yaptı { background-color: #10b981; } /* Canlı Yeşil (Emerald 500) */
		.Yaptı:hover { background-color: #059669; } 

		/* Mor - Gelmedi */
		.Gelmedi { background-color: #8b5cf6; } /* Mor (Violet 500) */
		.Gelmedi:hover { background-color: #7c3aed; } 

		/* Gri/Koyu - KitapYok */
		.KitapYok { background-color: #4b5563; } /* Koyu Gri (Gray 600) */
		.KitapYok:hover { background-color: #374151; }
        
        /* Düzenlenebilir Hücreler ve Focus Stili */
        .editable { background-color: #fff7e6; }
        [contenteditable]:focus { outline: 2px solid #3b82f6; outline-offset: -2px; }
        
        /* Flatpickr için hafif stil ayarlamaları (isteğe bağlı) */
        .flatpickr-input { 
            background-color: transparent !important;
            border: none !important;
            width: 100%;
            cursor: pointer;
            text-align: left;
            padding: 0;
            outline: none !important;
        }
		/* YENİ CSS: Kaydedilmemiş değişiklik için sade vurgu */
		.status.pending-change {
			/* Kaydedilmemişken rengi hafifçe soluklaştıralım */
			opacity: 0.5; 
		}
    </style>
</head>
<body class="font-sans bg-gray-100 p-5 md:p-10">
	<div class="flex justify-between items-center mb-2">
		<h1 class="text-xl font-bold text-gray-800">Çınarlar Vip Ödev Takip</h1>
		
		<div class="flex gap-3 items-center">
			<button id="btnExportJSON" class="bg-gray-600 text-white p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150">
				💾&nbsp;Yedekle
			</button>
			<button id="btnImportJSONTrigger" class="bg-gray-600 text-white p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150">
				📥&nbsp;Yükle
			</button>
			<input type="file" id="fileImport" accept=".json" class="hidden">
		</div>
	</div>
		<div id="saveNotification" class="fixed top-5 right-5 z-50 bg-green-500 text-white p-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none">
			✓ Kaydedildi!
	</div>
	<div class="bg-white p-4 rounded-lg shadow-md mb-2 flex flex-wrap gap-3 items-center">
        
        <input type="text" id="newClassName" placeholder="Yeni Sınıf Adı" 
               class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 flex-grow min-w-[150px]">
        
        <button id="btnAddClass" 
                class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition duration-150">
            Sınıf Ekle
        </button>
        
        <select id="classSelect" 
                class="p-2 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500 min-w-[150px]"></select>
        
        <button id="btnEditClass" 
                class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150">
            Sınıf Adını Düzenle
        </button>
        
        <input type="text" id="newStudent" placeholder="Yeni Öğrenci Adı" 
               class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 flex-grow min-w-[150px]">
        
        <button id="btnAddStudent" 
                class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition duration-150">
            Öğrenci Ekle
        </button>
    </div>

	<div class="add-homework bg-white p-4 rounded-lg shadow-md mb-6 flex flex-wrap gap-3 items-center">
			
		<input type="text" id="source" placeholder="Kaynak" 
			   class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 flex-grow min-w-[150px]">
			   
		<input type="text" id="topic" placeholder="Konu" 
			   class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 flex-grow min-w-[150px]">
			   
		<input type="text" id="pages" placeholder="Sayfa" 
			   class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-28"> 
			   
		<button id="btnAddHomework" 
				class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition duration-150 w-28">
			Ödevi Ekle
		</button>
	</div>

	<div class="filter-area bg-white p-2 rounded-lg shadow-md mb-2 flex flex-wrap gap-3 items-center hidden"> 
		<input type="text" id="filterRows" placeholder="Satır No Filtresi (Örn: 5, 10-15)" 
			   class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 flex-grow min-w-[200px]">

		<button id="btnClearFilter" 
				class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-150">
			Temizle
		</button>
	</div>
	<div id="tableContainer">
		<div id="tableHeaderArea" class="mt-2 mb-3 flex justify-between items-center p-2 bg-white rounded-lg shadow-md">			
		
			<h2 id="currentClassNameDisplay" class="text-l font-bold text-gray-700">Lütfen Bir Sınıf Seçin</h2>			
			<div class="flex gap-3 items-center">
				<button id="btnSaveStatuses" class="bg-red-500 text-white p-2 rounded-lg text-sm hover:bg-red-600 transition duration-150 hidden">
					Kaydet
				</button>
				
				
				
				<button id="btnShareToParent" class="bg-purple-600 text-white p-2 rounded-lg text-sm hover:bg-purple-700 transition duration-150">
					📸&nbsp;Paylaş
				</button>
				<button id="btnExportCSV" class="bg-gray-600 text-white p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150">Excele Aktar</button>			
			</div>	
		</div>
		<div class="overflow-x-auto shadow-lg rounded-lg">
			<table id="homeworkTable" class="min-w-full divide-y divide-gray-200">
				<thead id="tableHead" class="bg-blue-600">
				</thead>
				<tbody id="homeworkBody" class="bg-white divide-y divide-gray-200">
				</tbody>
			</table>
		</div>
	</div>
	
	<div id="studentModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
		<div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
			<h3 class="text-xl font-semibold mb-4 text-gray-800" id="modalTitle">Öğrenci Adını Düzenle</h3>
			
			<input type="text" id="modalStudentNameInput" placeholder="Yeni Öğrenci Adı" 
				   class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500 mb-4">
			
			<div class="flex justify-between items-center">
				<button id="btnDeleteStudent" 
						class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-150 text-sm">
					❌ Öğrenciyi Sil
				</button>
				<div class="flex gap-2">
					<button id="btnCancelModal" 
							class="bg-gray-400 text-white p-2 rounded-lg hover:bg-gray-500 transition duration-150 text-sm">
						İptal
					</button>
					<button id="btnSaveStudentName" 
							class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition duration-150 text-sm">
						Kaydet
					</button>
				</div>
			</div>
		</div>
	</div>
	<script>
		let classes; 
		let currentClass = '';
		const cycleStatuses = ["Yaptı", "Yapmadı", "Eksik", "Gelmedi", "KitapYok"];
		
		// YENİ: Düzenlenecek öğrencinin index'ini tutar
		let studentToEditIndex = -1; 
		
        document.addEventListener('DOMContentLoaded', function(){
		
            classes = JSON.parse(localStorage.getItem('classes') || '{}');
			//Ders adı bilgisi kaydediliyor/getiriliyor.
			const LESSON_STORAGE_KEY = 'lessonName';
			const DEFAULT_LESSON_NAME = 'Matematik'; // Varsayılan değer
			
			// 1. Kalıcı Veriyi Yükle veya Varsayılanı Ata
			let lessonName = localStorage.getItem(LESSON_STORAGE_KEY);
			
			if (!lessonName) {
				 // İlk defa açılıyorsa varsayılanı kullan ve kaydet
				 lessonName = DEFAULT_LESSON_NAME;
				 localStorage.setItem(LESSON_STORAGE_KEY, lessonName);
			}

            // YENİ: Kaydetme Bildirimini Gösteren Fonksiyon
			function showSaveNotification(isError = false, message = 'Kaydedildi!') { // İkinci parametreyi ekledik
				const notification = document.getElementById('saveNotification');
				
				notification.classList.remove('opacity-100', 'opacity-0', 'bg-green-500', 'bg-red-500');
				
				if (isError) {
					notification.classList.add('opacity-100', 'bg-red-500');
					notification.innerText = '❌ Hata: ' + message;
				} else {
					notification.classList.add('opacity-100', 'bg-green-500');
					notification.innerText = '✓ ' + message;
				}
				
				setTimeout(() => {
					notification.classList.remove('opacity-100');
					notification.classList.add('opacity-0');
				}, 2500); // 2.5 saniye yapalım, mesajlar uzun olabilir
			}

			// KAYDETME FONKSİYONUNU GÜNCELLE
			function saveData(){ 
				localStorage.setItem('classes', JSON.stringify(classes));
				// Bildirim çağırma artık dışarıda olacak
			}
			// YENİ: Statüleri Kaydetme Fonksiyonu
			function saveStatuses() {
				saveData();
				showSaveNotification();
				
				document.querySelectorAll('.status.pending-change').forEach(cell => {
					// Kaydedildi: * işaretini ve vurguyu kaldır
					cell.classList.remove('pending-change');
					
					// KRİTİK DEĞİŞİKLİK: * işaretini metinden kaldır
					cell.innerText = cell.innerText.replace('*', ''); 

					const hwIndex = cell.dataset.hw;
					const studentIndex = cell.dataset.student;
					const newOriginalStatus = classes[currentClass].homeworks[hwIndex].statuses[studentIndex];
                    cell.dataset.originalStatus = newOriginalStatus;

				});
				
				// Kaydetme butonunu gizle
				document.getElementById('btnSaveStatuses').classList.add('hidden');
			}

            // TARİH YARDIMCI FONKSİYONLARI
            function getIsoDate(date) {
                return date.toISOString().split('T')[0];
            }

            const monthNames = ["Oca", "Şub", "Mar", "Nis", "May", "Haz", "Tem", "Ağu", "Eyl", "Eki", "Kas", "Ara"];
            const dayNames = ["Paz", "Pzt", "Sal", "Çar", "Per", "Cum", "Cmt"];


            function updateClassSelect(selectValue){
                // ... (Sınıf Seçim Mantığı) ...
                const select = document.getElementById('classSelect');
                const prev = selectValue !== undefined ? selectValue : select.value;
                
                select.innerHTML = '<option value="">Sınıf Seçiniz</option>' + Object.keys(classes).map(cls=>`<option value="${cls}">${cls}</option>`).join('');
                
                if(prev && classes[prev]){
                    select.value = prev;
                    currentClass = prev;
                } else {
                    select.value = '';
                    currentClass = '';
                }
            }
			
			// YENİ YARDIMCI FONKSİYON: Satır aralığı metnini numaralar dizisine çevirir
			function parseRowRanges(rangeString) {
				if (!rangeString) return null; // Boşsa tüm satırları göster (null ile belirtelim)

				const uniqueRows = new Set();
				// Virgül ile ayrılmış parçalara ayır
				const parts = rangeString.split(',').map(p => p.trim()).filter(p => p.length > 0);

				for (const part of parts) {
					if (part.includes('-')) {
						// Aralık: 10-15 gibi
						const [startStr, endStr] = part.split('-').map(s => s.trim());
						const start = parseInt(startStr, 10);
						const end = parseInt(endStr, 10);

						if (!isNaN(start) && !isNaN(end) && start > 0 && end >= start) {
							// Başlangıç ve bitiş arasındaki tüm sayıları ekle
							for (let i = start; i <= end; i++) {
								uniqueRows.add(i);
							}
						}
					} else {
						// Tekil sayı: 5 gibi
						const num = parseInt(part, 10);
						if (!isNaN(num) && num > 0) {
							uniqueRows.add(num);
						}
					}
				}

				// Set'ten Array'e çevirip döndür
				return Array.from(uniqueRows);
			}

			// GÜNCELLENMİŞ applyFilter() FONKSİYONU (Sadece Satır Numarası)
			function applyFilter() {
				// Sadece Satır Numarası Filtresi Kullanılacak
				const rowRangeText = document.getElementById('filterRows').value.trim();
				
				// Satır Numarası Dizisini Oluştur
				const requiredRowNumbers = parseRowRanges(rowRangeText); 
				
				const rows = document.getElementById('homeworkBody').querySelectorAll('tr');

				rows.forEach((row, index) => {
					// Tablodaki ödev satırının #numarası, index+1'dir.
					const rowNumber = index + 1;
					
					// --- Satır Numarası Kontrolü ---
					// requiredRowNumbers null ise (yani boş) tüm satırlar eşleşir.
					// requiredRowNumbers içinde o satır numarası varsa eşleşir.
					const matchesRowNumber = requiredRowNumbers === null || requiredRowNumbers.includes(rowNumber);
					
					if (matchesRowNumber) {
						row.style.display = ''; // Göster
					} else {
						row.style.display = 'none'; // Gizle
					}
				});
			}


            function renderTable(){
                const tbody=document.getElementById('homeworkBody');
                const thead=document.getElementById('tableHead');
                const display = document.getElementById('currentClassNameDisplay');
				
				const lessonName = localStorage.getItem(LESSON_STORAGE_KEY) || DEFAULT_LESSON_NAME;
                const tableHeaderArea = document.getElementById('tableHeaderArea');
				// Yeni: Filtreleme alanını seç
				const filterArea = document.querySelector('.filter-area');
                
                // Tabloyu her zaman temizle
                thead.innerHTML = '';
                tbody.innerHTML = ''; 

                // Sınıf Seçili Değilse Başlığı Güncelle ve Durdur
                if(!currentClass || !classes[currentClass]){
                    display.innerText = 'Lütfen Bir Sınıf Seçin';
                    tableHeaderArea.classList.add('hidden'); 
					// YENİ: Filtreleme alanını gizle
					if(filterArea) filterArea.classList.add('hidden'); 
                    return; 
                }
                
                // Sınıf Seçili İse Başlığı Güncelle ve Tabloyu Oluşturmaya Başla
                tableHeaderArea.classList.remove('hidden');
				// YENİ: Filtreleme alanını göster
				if(filterArea) filterArea.classList.remove('hidden');
                
                // 🎯 KRİTİK GÜNCELLEME: Başlığa Ders Adı ve Düzenleme Yeteneği Ekleme
				display.innerHTML = `
					${currentClass} Sınıfı 
					<span id="editableLessonName" 
						contenteditable="false"
						title="Dersi değiştirmek için çift tıklayın."
						class="text-l text-blue-700 font-bold p-1 rounded cursor-pointer whitespace-nowrap
						focus:outline-none border border-transparent hover:bg-blue-50"
						  >${lessonName}</span> 
					Dersi Ödev Tablosu
				`;
				
				// Ders Adı Düzenleme Olay Dinleyicilerini Ekle
				const editableSpan = document.getElementById('editableLessonName');
				if (editableSpan) {
					
					// Çift Tıklama/Odaklanma ile düzenlemeye aç
					editableSpan.addEventListener('dblclick', function() {
						// contenteditable'ı TRUE yap ve odaklan
						this.setAttribute('contenteditable', 'true');
						this.focus();
						document.getSelection().collapse(this, 1); // İmleci sona taşı
						this.classList.remove('border-transparent');
						this.classList.add('border-blue-700');
					});
					
					// Odak kaybolduğunda (kaydetme)
					editableSpan.addEventListener('blur', function() {
						const newLesson = this.textContent.trim() || DEFAULT_LESSON_NAME;
						localStorage.setItem(LESSON_STORAGE_KEY, newLesson); // Kalıcı kaydet
						this.textContent = newLesson; // Değeri temizle
						
						// KRİTİK: contenteditable'ı FALSE yap ve tek tıklamayı engelle
						this.setAttribute('contenteditable', 'false');
						
						this.classList.remove('border-blue-700'); 
						this.classList.add('border-transparent');
						// Bildirim fonksiyonunuzu çağırın
						if (typeof showSaveNotification === 'function') {
							showSaveNotification(false, "Ders adı güncellendi.");
						}
					});

					// Enter tuşu ile kaydetme
					editableSpan.addEventListener('keydown', function(e) {
						if (e.key === 'Enter') {
							e.preventDefault(); 
							this.blur(); 
						}
					});
				}
               
                
                // ... (Tablo Başlığı Oluşturma Mantığı) ...
                const studentHeaders = classes[currentClass].students.map((s,i) => 
                    `<th class="px-2 py-3 text-xs font-semibold uppercase tracking-wider text-white bg-blue-700 cursor-pointer" data-index='${i}' title="Öğrenci adını düzenlemek veya silmek için çift tıklayın">${s}</th>`
                ).join('');
                
                thead.innerHTML = `
                    <tr>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">#</th>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">Kaynak</th>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">Konu</th>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">Sayfa</th>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">Veriliş T.</th>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">Kontrol T.</th>
                        ${studentHeaders}
                    </tr>
                `;


                // Tablo İçeriğini Oluştur
                classes[currentClass].homeworks.forEach((hw,hwIndex)=>{
                    const row=document.createElement('tr');
                    row.classList.add('hover:bg-gray-50');

                    // Tarih Hücreleri için INPUT alanı oluşturuldu
                    const givenDateInput = `<input type="text" readonly class="flatpickr-input" data-date-field="givenDate" data-hw='${hwIndex}' value="${formatDateTurkish(hw.givenDate) || ''}">`;
                    const checkDateInput = `<input type="text" readonly class="flatpickr-input" data-date-field="checkDate" data-hw='${hwIndex}' value="${formatDateTurkish(hw.checkDate) || ''}">`;


                    // Ödev Bilgileri Sütunları (DEĞİŞTİ: Sil butonu eklendi)
                    const hwCells = `
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center justify-between">
                            <span class="font-bold">${hwIndex+1}</span>
                            <button class="text-red-500 hover:text-red-700 p-1 rounded delete-homework-btn" data-hw='${hwIndex}' title="Ödevi Sil">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                        <td contenteditable class='editable px-2 py-2 whitespace-nowrap text-sm text-gray-700' data-field='source' data-index='${hwIndex}' data-type='text'>${hw.source || ''}</td>
                        <td contenteditable class='editable px-2 py-2 whitespace-nowrap text-sm text-gray-700' data-field='topic' data-index='${hwIndex}' data-type='text'>${hw.topic || ''}</td>
                        <td contenteditable class='editable px-2 py-2 whitespace-nowrap text-sm text-gray-700' data-field='pages' data-index='${hwIndex}' data-type='text'>${hw.pages || ''}</td>
                        
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-700 date-cell" data-field='givenDate' data-index='${hwIndex}'>${givenDateInput}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-700 date-cell" data-field='checkDate' data-index='${hwIndex}'>${checkDateInput}</td>
                    `;
                    
                    // Öğrenci Durum Sütunları
                    const statusCells = hw.statuses.map((status,studentIndex) => 
                        `<td class="status-cell">
                            <div class="status ${status}" 
                                data-hw='${hwIndex}' 
                                data-student='${studentIndex}'
                                data-original-status='${status}'>
                                ${status}
                            </div>
                        </td>`
                    ).join('');

                    row.innerHTML = hwCells + statusCells;
                    tbody.appendChild(row);
                });


                // 1. Düz Metin Alanları Düzenleme (Çift Tıklama)
                document.querySelectorAll('.editable').forEach(cell=>{
                    cell.setAttribute('contenteditable', 'false');

                    cell.removeEventListener('blur', cell._blurHandler);
                    cell.removeEventListener('keydown', cell._keyHandler);
                    cell.removeEventListener('dblclick', cell._dblclickHandler);

                    cell._blurHandler = function(){
                        const index = this.dataset.index;
                        const field = this.dataset.field;
                        classes[currentClass].homeworks[index][field] = this.innerText.trim();
                        saveData();
                        this.setAttribute('contenteditable', 'false');
                    };
                    
                    cell._keyHandler = function(e){
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.blur();
                        }
                    };
                    
                    cell._dblclickHandler = function(){
                        this.setAttribute('contenteditable', 'true');
                        this.focus();
						document.getSelection().collapse(this, 1); // 🔹 İmleci sona taşır
                    };

                    cell.addEventListener('blur', cell._blurHandler);
                    cell.addEventListener('keydown', cell._keyHandler);
                    cell.addEventListener('dblclick', cell._dblclickHandler); 
                });
                
                // 2. Durum Değiştirme (Tek Tıklama ve Kalıcı Vurgu)
				document.querySelectorAll('.status').forEach(cell => {
					// Önceki olay dinleyicilerini temizleyelim (İki tip dinleyiciyi de temizleyelim)
					cell.removeEventListener('click', cell._clickHandler);
					cell.removeEventListener('dblclick', cell._dblClickHandler); 

					// Tek tıklama için yeni dinleyiciyi tanımlayalım
					cell._clickHandler = function() {
						
						// 1. DURUM DEĞİŞİKLİĞİ MANTIĞI
						const hwIndex = Number(this.dataset.hw);
						const studentIndex = Number(this.dataset.student);
						const oldStatus = classes[currentClass].homeworks[hwIndex].statuses[studentIndex];
						let newStatus = ''; 
						
						if (oldStatus === "") {
							newStatus = cycleStatuses[0]; 
						} else {
							let currentCycleIndex = cycleStatuses.indexOf(oldStatus);
							currentCycleIndex = (currentCycleIndex + 1) % cycleStatuses.length;
							newStatus = cycleStatuses[currentCycleIndex];
						}
						
						// Kaydetmek yerine sadece veriyi güncelle
						classes[currentClass].homeworks[hwIndex].statuses[studentIndex] = newStatus;

						// 2. VİSUEL GÜNCELLEME 
						if (oldStatus !== "") {
							this.classList.remove(oldStatus);
						}
						this.classList.add(newStatus); 
                        this.innerText = newStatus;
                        //DOM'dan kayıtlı değeri al
                        const originalStatus = this.dataset.originalStatus;

                        if(newStatus === originalStatus){
                            //durum orijinal değerine geri döndü: Görseli temizle
                            this.classList.remove('pending-change');
                            this.innerText = newStatus; //Yıldızı kaldır
                        }else{
                            //durum kayıtlı değerden farklı ise Vurgula
                            this.classList.add('pending-change');
                            //durum metnine yıldız(*) ekle tabi yoksa
                            if(!this.innerText.includes('*')){
                                this.innerText = newStatus + '*';
                            }
                        }


						// Kaydetme butonunu göster/gizle
                        const hasPendingChanges = document.querySelectorAll('.status.pending-change').length > 0;
                        if(hasPendingChanges){
                            document.getElementById('btnSaveStatuses').classList.remove('hidden');
                        } else{
                            document.getElementById('btnSaveStatuses').classList.add('hidden');
                        }		

					};
					
					cell.addEventListener('click', cell._clickHandler);
				});

                // 3. Öğrenci Adı Düzenleme ve Silme (Modal Açma)
                document.querySelectorAll('#tableHead th[data-index]').forEach(th => {
                    const index = Number(th.dataset.index);
                    const studentName = classes[currentClass].students[index];

                    // Önceki tüm dinleyicileri kaldır 
                    th.removeEventListener('dblclick', th._dblHandler); 

                    // Yeni çift tıklama dinleyicisi: Modalı açar
                    th._dblHandler = function() {
                        // Global index'i ayarla
                        studentToEditIndex = index; 
                        
                        const currentName = classes[currentClass].students[index];
                        
                        // Modal içeriğini doldur
                        document.getElementById('modalStudentNameInput').value = currentName;
                        document.getElementById('modalTitle').textContent = `"${currentName}" öğrencisini yönet`;

                        // Modalı göster
                        document.getElementById('studentModal').classList.remove('hidden');
                        document.getElementById('studentModal').classList.add('flex'); // Tailwind ile ortalamak için flex
                        document.getElementById('modalStudentNameInput').focus();
                    };
                    th.addEventListener('dblclick', th._dblHandler);
                    
                    // İpucunu güncelle
                    th.title = `Öğrenci adını düzenlemek veya silmek için çift tıklayın.`;
                });
                
                // 4. Flatpickr (Tarih) Entegrasyonu
                document.querySelectorAll('.flatpickr-input').forEach(input => {
                    const hwIndex = Number(input.dataset.hw);
                    const field = input.dataset.dateField;
                    
                    // Flatpickr'ı başlat
                    flatpickr(input, {
                        locale: 'tr', // Türkçe dil
                        defaultDate: classes[currentClass].homeworks[hwIndex][field], // Mevcut ISO tarihi
                        dateFormat: "Y-m-d", // Veritabanı (localStorage) formatı
                        altInput: true,
                        altFormat: "j M. D", // Görünen format: 17 Tem. Salı
                        
                        // Tarih seçildiğinde
                        onClose: function(selectedDates, dateStr, instance) {
                            if (selectedDates.length > 0) {
                                // Yeni tarihi kaydet
                                classes[currentClass].homeworks[hwIndex][field] = dateStr;
                                saveData();
                            }
                        }
                    });
                });
				
				// 5. Ödev Silme Butonlarını Bağlama (YENİ EKLEME)
				document.querySelectorAll('.delete-homework-btn').forEach(btn => {
					// Önceki dinleyiciyi temizle
					btn.removeEventListener('click', btn._deleteHandler); 
					btn._deleteHandler = function() {
						const hwIndex = Number(this.dataset.hw);
						deleteHomework(hwIndex);
					};
					btn.addEventListener('click', btn._deleteHandler);
				});

				
				// Tablo yeniden çizildikten sonra mevcut filtre metnini tekrar uygula
				if (document.getElementById('filterRows') && document.getElementById('filterRows').value.trim() !== '') {
					applyFilter();
				}

            }

            function loadClass(){
                currentClass = document.getElementById('classSelect').value;
                renderTable();
            }

            // ÖĞRENCİ SİLME FONKSİYONU (MODAL İLE ÇALIŞACAK ŞEKİLDE GÜNCELLENDİ)
            function removeStudent() {
                if(!currentClass || studentToEditIndex === -1){ return; }

                const studentName = classes[currentClass].students[studentToEditIndex];

                const confirmation = confirm(
                    `❗ DİKKAT: "${currentClass}" sınıfından "${studentName}" adlı öğrenciyi silmek üzeresiniz.\n\n` +
                    `Bu işlem, öğrencinin TÜM ödev durumlarını kalıcı olarak silecektir.\n` +
                    `Devam etmek istediğinizden emin misiniz?`
                );

                if (confirmation) {
                    // Öğrenciyi listeden sil
                    classes[currentClass].students.splice(studentToEditIndex, 1);
                    
                    // Bu öğrenciye ait tüm ödev durumlarını sil (her ödevden o index'teki durumu çıkar)
                    classes[currentClass].homeworks.forEach(hw => {
                        if (hw.statuses && hw.statuses.length > studentToEditIndex) {
                            hw.statuses.splice(studentToEditIndex, 1);
                        }
                    });

                    saveData(); 
                    renderTable(); 
                    showSaveNotification(false, `${studentName} başarıyla silindi.`);

                    // Modalı Kapat
                    document.getElementById('studentModal').classList.add('hidden');
                    document.getElementById('studentModal').classList.remove('flex');
                    studentToEditIndex = -1; // Index'i sıfırla
                }
            }
            
			// ÖDEV SİLME FONKSİYONU (YENİ)
            function deleteHomework(hwIndex) {
                if (!currentClass || hwIndex === undefined || !classes[currentClass].homeworks[hwIndex]) return;

                const hw = classes[currentClass].homeworks[hwIndex];
                const confirmation = confirm(
                    `❗ DİKKAT: "${hw.source} - ${hw.topic} (Sayfa: ${hw.pages})" ödevini silmek üzeresiniz.\n\n` +
                    `Bu işlem, bu ödeve ait tüm öğrenci durumlarını kalıcı olarak silecektir.\n` +
                    `Devam etmek istediğinizden emin misiniz?`
                );

                if (confirmation) {
                    // Ödevi listeden sil
                    classes[currentClass].homeworks.splice(hwIndex, 1);
                    saveData();
                    renderTable();
                    showSaveNotification(false, "Ödev başarıyla silindi.");
                }
            }

            function addClass(){
                const nameInput = document.getElementById('newClassName');
                const name = nameInput.value.trim();
                if(!name){ alert('Lütfen bir sınıf adı girin.'); return; }
                if(!classes[name]){
                    classes[name] = { students: [], homeworks: [] };
                    updateClassSelect(name); 
                    document.getElementById('classSelect').value = name;
                    currentClass = name; 
                    renderTable(); saveData();
                } else {
                    alert(`'${name}' adında bir sınıf zaten mevcut.`);
                }
                nameInput.value = '';
            }
            
            function editClass(){
                if(!currentClass){ alert('Önce düzenlemek istediğiniz sınıfı seçin.'); return; }
                const newName = prompt('Yeni sınıf adı:', currentClass);
                if(newName && newName.trim() !== currentClass && !classes[newName.trim()]){
                    classes[newName.trim()] = classes[currentClass];
                    delete classes[currentClass];
                    updateClassSelect(newName.trim());
                    document.getElementById('classSelect').value = newName.trim();
                    currentClass = newName.trim();
                    saveData(); renderTable();
                } else if (newName && newName.trim() !== currentClass) {
                    alert(`'${newName.trim()}' adında bir sınıf zaten mevcut veya boş bir isim girdiniz.`);
                }
            }

            function addStudent(){
                if(!currentClass){ alert('Önce öğrenci eklemek istediğiniz sınıfı seçin.'); return; }
                const nameInput = document.getElementById('newStudent');
                const name = nameInput.value.trim();
                
                if(!name){ alert('Lütfen bir öğrenci adı girin.'); return; }
                
                if(!classes[currentClass].students.includes(name)){
                    classes[currentClass].students.push(name);
                    classes[currentClass].homeworks.forEach(hw => hw.statuses.push("")); 
                    saveData(); 
                    renderTable(); 
                } else {
                    alert(`'${name}' adlı öğrenci zaten bu sınıfta.`);
                }
                nameInput.value = '';
            }


            // Ödev Ekleme (Basitleştirildi: Tarih otomatik atanacak)
            function addHomework(){
                if(!currentClass){ alert('Önce ödev eklemek istediğiniz sınıfı seçin.'); return; }
                
                const sourceInput = document.getElementById('source');
                const topicInput = document.getElementById('topic');
                const pagesInput = document.getElementById('pages');

                const source = sourceInput.value.trim();
                const topic = topicInput.value.trim();
                const pages = pagesInput.value.trim();
                
                if(!source || !topic || !pages){ alert('Kaynak, Konu ve Sayfa alanlarını doldurun.'); return; }
                
                // Tarihleri Otomatik Olarak Ata (Bugün ve 7 gün sonrası)
                let givenDateObj = new Date();
                let givenDate = getIsoDate(givenDateObj);
                
                let checkDateObj = new Date(givenDateObj);
                checkDateObj.setDate(givenDateObj.getDate() + 7);
                let checkDate = getIsoDate(checkDateObj);
                
                const hw = { 
                    source, 
                    topic, 
                    pages, 
                    givenDate, // ISO formatında sakla
                    checkDate, // ISO formatında sakla
                    statuses: classes[currentClass].students.map(()=> "") 
                };
                
                classes[currentClass].homeworks.push(hw);
                saveData(); 
                renderTable(); 
                
                // Form alanlarını temizle
                sourceInput.value = '';
                topicInput.value = '';
                pagesInput.value = '';
            }
            
			// exportJSON fonksiyonu
			function exportAllData() {
				// 1️⃣ Kaydedilmiş sınıf verisi var mı kontrol et
				if (!classes || !Object.keys(classes).length) {
					alert('Kaydedilmiş sınıf verisi bulunmamaktadır.');
					return;
				}

			try {
				// 2️⃣ JSON verisini oluştur
				const jsonData = JSON.stringify(classes, null, 2);

				// 3️⃣ Blob nesnesi oluştur (gerçek dosya gibi davranır)
				const blob = new Blob([jsonData], { type: "application/json;charset=utf-8" });

				// 4️⃣ Blob için geçici bir URL oluştur
				const url = URL.createObjectURL(blob);

				// 5️⃣ <a> etiketiyle indirme işlemini başlat
				const dl = document.createElement('a');
				dl.href = url;
				dl.download = 'odev_takip_yedek_' + new Date().toISOString().split('T')[0] + '.json';

				document.body.appendChild(dl);
				dl.click(); // otomatik indir
				document.body.removeChild(dl);

				// 6️⃣ Bellek temizliği (Blob URL’ini serbest bırak)
				URL.revokeObjectURL(url);


			} catch (err) {
				console.error("Yedekleme sırasında hata oluştu:", err);
				alert("Bir hata oluştu, yedekleme başarısız oldu. Tarayıcınızı yeniden deneyin.");
			}
			}
			function formatDateTurkish(isoDate) {
				if (!isoDate) return '';
				
				// YYYY-MM-DD formatındaki tarihi Date nesnesine çevir
				const parts = isoDate.split('-');
				// Not: Ay indeksi 0'dan başlar (parts[1] - 1)
				const date = new Date(parts[0], parts[1] - 1, parts[2]);

				const options = { 
					day: 'numeric',   // Günü sayı olarak (15)
					month: 'long',    // Ay ismini tam olarak (Ekim)
					weekday: 'long'   // Haftanın gününü tam olarak (Çarşamba)
				};
				
				// Bu formatı elde etmek için daha spesifik bir ayar kullanalım
				const day = date.getDate();
				const month = date.toLocaleDateString('tr-TR', { month: 'long' });
				const weekday = date.toLocaleDateString('tr-TR', { weekday: 'long' });

				// İstediğiniz virgülsüz formatı boşluklarla birleştirir
				return `${day} ${month} ${weekday}`;
				// Çıktı Örn: 15 Ekim Çarşamba
			}
            function exportCSV() {
				if (!currentClass) {
					alert('Lütfen önce dışa aktarmak istediğiniz sınıfı seçin.');
					return;
				}

				// UTF-8 BOM: Türkçe karakterlerin Excel’de düzgün görünmesi için
				const BOM = "\uFEFF";

				const header = [
					'#',
					'Kaynak',
					'Konu',
					'Sayfa',
					'Veriliş T.',
					'Kontrol T.',
					...classes[currentClass].students
				];

				const rows = classes[currentClass].homeworks.map((hw, idx) => {
					const pagesValue =
						(hw.pages || '').includes('-') || (hw.pages || '').includes('/')
							? "'" + hw.pages
							: hw.pages;

					return [
						idx + 1,
						hw.source,
						hw.topic,
						pagesValue,
						formatDateTurkish(hw.givenDate), // Veriliş Tarihi
						formatDateTurkish(hw.checkDate), // Kontrol Tarihi
						...hw.statuses
					];
				});

				// CSV için güvenli değer dönüşümü
				const cleanAndQuote = (val) => {
					if (val === null || val === undefined) return '';
					const strVal = String(val).replace(/\n/g, ' ').trim();
					return `"${strVal.replace(/"/g, '""')}"`;
				};

				// ✅ 1. Satır: SINIF başlığı (tüm sütun sayısına göre doğru şekilde oluşturulur)
				const classTitleRow = [
					`SINIF: ${currentClass}`,
					...new Array(header.length - 1).fill('')
				].map(cleanAndQuote).join(';');

				// ✅ 2. Satır: Sütun başlıkları + 3. ve sonraki satırlar: ödevler
				const csv = [
					classTitleRow,
					header.map(cleanAndQuote).join(';'),
					...rows.map(r => r.map(cleanAndQuote).join(';'))
				].join('\n');

				// ✅ CSV dosyasını oluştur ve indir
				const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
				const url = URL.createObjectURL(blob);

				const dl = document.createElement('a');
				dl.href = url;
				dl.download = `${currentClass}_odev_takip_${new Date()
					.toISOString()
					.split('T')[0]}.csv`;

				document.body.appendChild(dl);
				dl.click();
				document.body.removeChild(dl);
				URL.revokeObjectURL(url);
			}

			function importData(event) {
			  const file = event.target.files[0];
			  if (!file) return;

			  const reader = new FileReader();

			  reader.onload = (e) => {
				try {
				  const data = JSON.parse(e.target.result);

				  // 1️⃣ JSON geçerli mi ve beklenen yapıda mı?
				  if (!data || typeof data !== 'object' || Array.isArray(data)) {
					alert("❌ Geçersiz dosya yapısı: Bir 'ödev takip dosyası' JSON'u bekleniyor.");
					event.target.value = '';
					return;
				  }

				  const hasValidStructure = Object.values(data).every(
					cls => typeof cls === 'object' && !Array.isArray(cls)
				  );

				  if (!hasValidStructure) {
					alert("❌ Geçersiz içerik: Dosya 'ödev takip dosyası' içermiyor.");
					event.target.value = '';
					return;
				  }

				  // 2️⃣ JSON doğruysa, şimdi kullanıcıdan onay iste
				  const isConfirmed = confirm("📦 Yedekten veri yüklenecek.\n\n" +
					"Bu işlem mevcut SINIF ve ÖDEV verilerinizi yedekteki verilerle değiştirecektir.\n" +
					"Eğer mevcut verilerinizi korumak istiyorsanız, lütfen önce yedek alın.\n" +
					"Devam etmek istiyor musunuz?");
				  if (!isConfirmed) {
					event.target.value = '';
					return;
				  }

				  // 3️⃣ Onay verildiyse veriyi kaydet
				  localStorage.setItem('classes', JSON.stringify(data));
				  classes = data;

				  updateClassSelect();

				  const firstClass = Object.keys(classes)[0];
				  if (firstClass) {
					document.getElementById('classSelect').value = firstClass;
					currentClass = firstClass;
				  }

				  renderTable();
				  showSaveNotification(false, "Veriler başarıyla içe aktarıldı.");
				} 
				catch (err) {
				  console.error("İçe aktarma hatası:", err);
				  alert("❌ Hata: Dosya JSON formatında değil.");
				}

				event.target.value = ''; // input temizle
			  };

			  reader.readAsText(file);
			}



            // Olay Dinleyicileri
            document.getElementById('btnAddClass').addEventListener('click', addClass);
            document.getElementById('btnEditClass').addEventListener('click', editClass);
            document.getElementById('btnAddStudent').addEventListener('click', addStudent);
            document.getElementById('btnAddHomework').addEventListener('click', addHomework);
            document.getElementById('btnExportJSON').addEventListener('click', exportAllData);
			
			document.getElementById('btnImportJSONTrigger').addEventListener('click', () => {
				document.getElementById('fileImport').click(); // Gizli input'u tetikle
				});
			// Dosya seçildiğinde içe aktarma fonksiyonunu çalıştır:
			document.getElementById('fileImport').addEventListener('change', importData);
			
            document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
            document.getElementById('classSelect').addEventListener('change', loadClass);
			
			document.getElementById('btnSaveStatuses').addEventListener('click', saveStatuses)
			
			// Paylaş butonunu bağla
			document.getElementById('btnShareToParent').addEventListener('click', shareTableAsImage);
			
			// FİLTRELEME OLAY DİNLEYİCİLERİ
			// Metin filtreleme kaldırıldı, sadece Satır No filtresi kaldı
			document.getElementById('filterRows').addEventListener('input', applyFilter);
			
			document.getElementById('btnClearFilter').addEventListener('click', function() {
				document.getElementById('filterRows').value = '';
				applyFilter();
			});
			
			// MODAL OLAY DİNLEYİCİLERİ
			document.getElementById('btnCancelModal').addEventListener('click', function() {
				document.getElementById('studentModal').classList.add('hidden');
				document.getElementById('studentModal').classList.remove('flex');
				studentToEditIndex = -1; // Index'i sıfırla
			});

			document.getElementById('btnSaveStudentName').addEventListener('click', function() {
				if (studentToEditIndex === -1) return;

				const newName = document.getElementById('modalStudentNameInput').value.trim();
				const oldName = classes[currentClass].students[studentToEditIndex];

				if (newName && newName !== oldName) {
					if (!classes[currentClass].students.includes(newName)) {
						classes[currentClass].students[studentToEditIndex] = newName;
						saveData(); 
						renderTable();
						showSaveNotification(false, `Öğrenci adı "${oldName}" -> "${newName}" olarak güncellendi.`);
						document.getElementById('btnCancelModal').click(); // Modalı kapat
					} else {
						alert(`'${newName}' adlı öğrenci zaten bu sınıfta.`);
					}
				} else if (newName === oldName) {
					document.getElementById('btnCancelModal').click(); // Değişiklik yoksa kapat
				} else {
					alert('Lütfen geçerli bir öğrenci adı girin.');
				}
			});

			document.getElementById('btnDeleteStudent').addEventListener('click', removeStudent);

			document.getElementById('modalStudentNameInput').addEventListener('keydown', function(e) {
				if (e.key === 'Enter') {
					e.preventDefault(); 
					document.getElementById('btnSaveStudentName').click(); 
				}
			});
			
            // Başlangıç Mantığı
            updateClassSelect();
            if(currentClass) loadClass(); else renderTable();
        });
		
		// JavaScript <script> bloğunda, mevcut fonksiyonlarınızın arasına ekleyin:

		// GÜNCELLENMİŞ shareTableAsImage FONKSİYONU
		async function shareTableAsImage() {
			if (!currentClass) {
				// Hata yönetimi aynı kalır...
				return;
			}
			
			const shareButton = document.getElementById('btnShareToParent');
			const originalText = shareButton.innerHTML;
			shareButton.innerHTML = '📸&nbsp;Hazırlanıyor...';
			shareButton.disabled = true;

			const tableContainer = document.getElementById('tableContainer'); // Ana Kapsayıcı (Görüntülenen Alan)
			if (!tableContainer) {
				// Hata yönetimi aynı kalır...
				return;
			}
			
			// Gerekli Elemanları Seçme
			const tableElement = document.getElementById('homeworkTable'); // Tablonun Kendisi
			const tableDiv = tableContainer.querySelector('.overflow-x-auto');
			const headerArea = document.getElementById('tableHeaderArea'); // Başlık ve Butonları Saran Alan
			const currentClassNameArea = document.getElementById('currentClassNameDisplay'); // H2 Başlığı
			const headerDiv = headerArea.querySelector('.flex.gap-3.items-center'); // Butonları saran Flex div
			const exportCSVButton = document.getElementById('btnExportCSV');
			const saveStatusesButton = document.getElementById('btnSaveStatuses'); // Kaydet butonunu da gizle
			
			// YENİ: Ödev Silme Butonlarını Seç ve Durumlarını Sakla
			const deleteButtons = document.querySelectorAll('.delete-homework-btn');
			const originalDeleteButtonStyles = [];

			// --- 1. Orijinal CSS Yedeklerini Saklama (Temizlik için KRİTİK) ---
			
			const originalOverflow = tableDiv ? tableDiv.style.overflowX : '';
			const originalContainerPadding = tableContainer.style.padding;
			const originalContainerMargin = tableContainer.style.margin;
			
			// KRİTİK YENİ YEDEK: tableContainer'ın orijinal genişliğini sakla
			const originalContainerWidth = tableContainer.style.width; 
			
			// Başlık alanının ve butonların orijinal stillerini sakla
			const originalCurrentClassNameWhitespace = currentClassNameArea ? currentClassNameArea.style.whiteSpace : '';
			const originalHeaderDisplay = headerDiv ? headerDiv.style.display : '';
			const shareButtonDisplay = shareButton.style.display;
			const exportCSVDisplay = exportCSVButton ? exportCSVButton.style.display : '';
			const saveStatusesDisplay = saveStatusesButton ? saveStatusesButton.style.display : '';
			
			// --- 2. Görüntü Öncesi Geçici CSS Değişiklikleri ---

			// Butonları gizle ve Header'daki flex düzenini boz
			shareButton.style.display = 'none';
			if(exportCSVButton) exportCSVButton.style.display = 'none';
			if(saveStatusesButton) saveStatusesButton.style.display = 'none'; // Kaydet butonunu da gizle
			
			// YENİ: Silme butonlarını gizle
			deleteButtons.forEach(btn => {
				originalDeleteButtonStyles.push({ element: btn, display: btn.style.display });
				btn.style.display = 'none'; // Geçici olarak gizle
			});
			
			if (headerDiv) headerDiv.style.display = 'block';

			// *** KRİTİK GENİŞLİK ÇÖZÜMÜ: tableContainer'i tablonun genişliğine zorla ***
			if (tableElement) {
				// Ana kapsayıcının genişliğini, tablonun gerçek (kaydırılmamış) genişliğine eşitle
				tableContainer.style.width = tableElement.scrollWidth + 'px';
				// Tablo başlık alanının da genişliğini eşitlemek, boşluk kalmasını engeller
				headerArea.style.width = tableElement.scrollWidth +  'px';
			}
 

			// Diğer Layout Düzeltmeleri
			if (tableDiv) {
				tableDiv.style.overflowX = 'visible'; // Kaydırmayı kapat
				tableDiv.style.width = 'auto';
				tableDiv.style.maxWidth = 'none';
			}
 
			tableContainer.style.padding = '5px';
			tableContainer.style.margin = '5px auto';
			tableContainer.style.backgroundColor = '#ffffff';
			if (currentClassNameArea) currentClassNameArea.style.whiteSpace = 'nowrap'; // Başlık metnini tek satıra zorla

			// Düzenlenebilir alanların focus durumunu kaldır
			document.querySelectorAll('[contenteditable="true"]').forEach(el => el.blur());


			// --- 3. dom-to-image çağrısı ---
			
			domtoimage.toPng(tableContainer, {
				bgcolor: '#ffffff',
				// Genişliği CSS ile ayarladığımız için, offsetWidth kullanmak yeterlidir.
				width: tableContainer.scrollWidth, 
				height: tableContainer.scrollHeight,
			})
			.then(async function (dataUrl) {
		
				// Görüntü Dosyasının Adı
				const filename = `${currentClass}_odev_tablo_${new Date().toISOString().split('T')[0]}.png`;

				// Mobil Paylaşım Kontrolü (Web Share API)
				if (navigator.share && navigator.canShare && dataUrl) {
					
					// Data URL'yi Blob nesnesine dönüştürme
					const blob = await (await fetch(dataUrl)).blob();
					const file = new File([blob], filename, { type: 'image/png' });

					try {
						await navigator.share({
							files: [file],
							title: 'Sınıf Ödev Tablosu',
							text: `${currentClass} Sınıfı için ödev tablosu görselini paylaşıyorum.`,
						});
						showSaveNotification(false, "Tablo resmi başarıyla paylaşıldı!");
						
					} catch (error) {
						if (error.name !== 'AbortError') {
							console.error('Web Share API hatası:', error);
							showSaveNotification(true, "Paylaşım başlatılırken bir sorun oluştu.");
						}
					}
					
				} else {
					// Masaüstü Desteği (İndirme)
					const dl = document.createElement('a');
					dl.href = dataUrl;
					dl.download = filename;

					document.body.appendChild(dl);
					dl.click();
					document.body.removeChild(dl);
					
					showSaveNotification(false, "Tablo resmi cihazınıza indirildi. Şimdi paylaşabilirsiniz!");
				}
			})
			.catch(function (error) {
				showSaveNotification(true, "Görsel oluşturulurken bir hata oluştu: " + error.message);
			})
			.finally(() => {
				// --- 4. TEMİZLİK: TÜM GEÇİCİ DEĞİŞİKLİKLERİ GERİ AL ---
				
				// KRİTİK: Genişliği geri yükle
				tableContainer.style.width = originalContainerWidth;
				headerArea.style.width = ''; // Header genişliğini kaldır

				// Diğer Layout Geri Yüklemeleri
				tableContainer.style.margin = originalContainerMargin;
				tableContainer.style.padding = originalContainerPadding;
				tableContainer.style.backgroundColor = '';

				// Butonları ve Layout'u geri getir
				shareButton.style.display = shareButtonDisplay;
				if(exportCSVButton) exportCSVButton.style.display = exportCSVDisplay;
				if(saveStatusesButton) saveStatusesButton.style.display = saveStatusesDisplay;
				
				// YENİ: Ödev Silme Butonlarının Durumunu Geri Yükle
				originalDeleteButtonStyles.forEach(item => {
					item.element.style.display = item.display;
				});
				
				if (headerDiv) headerDiv.style.display = originalHeaderDisplay;
				if (currentClassNameArea) currentClassNameArea.style.whiteSpace = originalCurrentClassNameWhitespace;
				if (tableDiv) tableDiv.style.overflowX = originalOverflow;
				
				// Butonu sıfırla
				shareButton.innerHTML = originalText;
				shareButton.disabled = false;
			});
		}
    </script>

</body>
</html>