<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã–dev Takip Sistemi - Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
    	<script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
    <style>
        /* SAF CSS: Durum Butonu Stilleri */
        .status-cell { 
			margin: 0px;
            padding: 2px; 
            white-space: nowrap;
        }

        .status { 
            cursor: pointer; 
            border-radius: 6px; 
            padding: 12px 6px; /* Dikey padding rahatlatÄ±ldÄ± */
            color: white; 
            transition: background-color 0.15s ease-in-out;
            font-weight: 500;
            font-size: 0.75rem; /* text-xs'e geri dÃ¶ndÃ¼ */
            line-height: 1;
            width: 100%; 
            min-width: 5rem;
            display: flex;
            align-items: center;
            justify-content: center;
			/* YENÄ°: Emoji konumlandÄ±rma iÃ§in */
			position: relative; 
        }

		/* YENÄ°: BoÅŸ StatÃ¼: GÃ¶rÃ¼nmez baÅŸlangÄ±Ã§ durumu iÃ§in */
		.status:empty {
			background-color: #f9f9f9; /* Hafif gri arka plan */
			color: #1f2937; /* Siyah metin */
			border: 1px solid #d1d5db; /* Hafif kenarlÄ±k */
			min-height: 2.25rem; /* Buton yÃ¼ksekliÄŸini korur */
			padding: 0;
			line-height: 2.25rem; /* YÃ¼ksekliÄŸi ortalamak iÃ§in */
		}

			/* YENÄ° VE CANLI RENK PALETÄ° */
		/* KÄ±rmÄ±zÄ± - YapmadÄ± */
		.YapmadÄ± { background-color: #ef4444; } /* KÄ±rmÄ±zÄ± (Red 500) */
		.YapmadÄ±:hover { background-color: #dc2626; } 

		/* Turuncu/SarÄ± - Eksik */
		.Eksik { background-color: #f59e0b; } /* Turuncu (Amber 500) */
		.Eksik:hover { background-color: #d97706; } 

		/* YeÅŸil - YaptÄ± */
		.YaptÄ± { background-color: #10b981; } /* CanlÄ± YeÅŸil (Emerald 500) */
		.YaptÄ±:hover { background-color: #059669; } 

		/* Mor - Gelmedi */
		.Gelmedi { background-color: #8b5cf6; } /* Mor (Violet 500) */
		.Gelmedi:hover { background-color: #7c3aed; } 

		/* Gri/Koyu - KitapYok */
		.KitapYok { background-color: #4b5563; } /* Koyu Gri (Gray 600) */
		.KitapYok:hover { background-color: #374151; }
        
        /* DÃ¼zenlenebilir HÃ¼creler ve Focus Stili */
        .editable { background-color: #fff7e6; }
        [contenteditable]:focus { outline: 2px solid #3b82f6; outline-offset: -2px; }
        
        /* Flatpickr iÃ§in hafif stil ayarlamalarÄ± (isteÄŸe baÄŸlÄ±) */
        .flatpickr-input { 
            background-color: transparent !important;
            border: none !important;
            width: 100%;
            cursor: pointer;
            text-align: left;
            padding: 0;
            outline: none !important;
        }
		/* YENÄ° CSS: KaydedilmemiÅŸ deÄŸiÅŸiklik iÃ§in sade vurgu */
		.status.pending-change {
			/* KaydedilmemiÅŸken rengi hafifÃ§e soluklaÅŸtÄ±ralÄ±m */
			opacity: 0.5; 
		}
    </style>
</head>
<body class="font-sans bg-gray-100 p-5 md:p-10">
	<div class="flex justify-between items-center mb-2">
		<h1 class="text-xl font-bold text-gray-800">Ã‡Ä±narlar Vip Ã–dev Takip</h1>
		
		<div class="flex gap-3 items-center">
			<button id="btnExportJSON" class="bg-gray-600 text-white p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150">
				ğŸ’¾&nbsp;Yedekle
			</button>
			<button id="btnImportJSONTrigger" class="bg-gray-600 text-white p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150">
				ğŸ“¥&nbsp;YÃ¼kle
			</button>
			<input type="file" id="fileImport" accept=".json" class="hidden">
		</div>
	</div>
		<div id="saveNotification" class="fixed top-5 right-5 z-50 bg-green-500 text-white p-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none">
			âœ“ Kaydedildi!
	</div>
	<div class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-wrap gap-3 items-center">
        
        <input type="text" id="newClassName" placeholder="Yeni SÄ±nÄ±f AdÄ±" 
               class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 flex-grow min-w-[150px]">
        
        <button id="btnAddClass" 
                class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition duration-150">
            SÄ±nÄ±f Ekle
        </button>
        
        <select id="classSelect" 
                class="p-2 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500 min-w-[150px]"></select>
        
        <button id="btnEditClass" 
                class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150">
            SÄ±nÄ±f AdÄ±nÄ± DÃ¼zenle
        </button>
        
        <input type="text" id="newStudent" placeholder="Yeni Ã–ÄŸrenci AdÄ±" 
               class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 flex-grow min-w-[150px]">
        
        <button id="btnAddStudent" 
                class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition duration-150">
            Ã–ÄŸrenci Ekle
        </button>
    </div>

	<div class="add-homework bg-white p-4 rounded-lg shadow-md mb-6 flex flex-wrap gap-3 items-center">
			
		<input type="text" id="source" placeholder="Kaynak" 
			   class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 flex-grow min-w-[150px]">
			   
		<input type="text" id="topic" placeholder="Konu" 
			   class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 flex-grow min-w-[150px]">
			   
		<input type="text" id="pages" placeholder="Sayfa" 
			   class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-28"> 
			   
		<button id="btnAddHomework" 
				class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition duration-150 w-28">
			Ã–devi Ekle
		</button>
	</div>
	<div id="tableContainer">
		<div id="tableHeaderArea" class="mt-4 mb-3 flex justify-between items-center p-2 bg-white rounded-lg shadow-md">			
		
			<h2 id="currentClassNameDisplay" class="text-l font-bold text-gray-700">LÃ¼tfen Bir SÄ±nÄ±f SeÃ§in</h2>			
			<div class="flex gap-3 items-center">
				<button id="btnSaveStatuses" class="bg-red-500 text-white p-2 rounded-lg text-sm hover:bg-red-600 transition duration-150 hidden">
					Kaydet
				</button>
				
				
				
				<button id="btnShareToParent" class="bg-purple-600 text-white p-2 rounded-lg text-sm hover:bg-purple-700 transition duration-150">
					ğŸ“¸&nbsp;PaylaÅŸ
				</button>
				<button id="btnExportCSV" class="bg-gray-600 text-white p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150">Excele Aktar</button>			
			</div>	
		</div>
		<div class="overflow-x-auto shadow-lg rounded-lg">
			<table id="homeworkTable" class="min-w-full divide-y divide-gray-200">
				<thead id="tableHead" class="bg-blue-600">
				</thead>
				<tbody id="homeworkBody" class="bg-white divide-y divide-gray-200">
				</tbody>
			</table>
		</div>
	</div>
    <script>
		let classes; 
		let currentClass = '';
		const cycleStatuses = ["YaptÄ±", "YapmadÄ±", "Eksik", "Gelmedi", "KitapYok"];
        document.addEventListener('DOMContentLoaded', function(){
		
            classes = JSON.parse(localStorage.getItem('classes') || '{}');
			//Ders adÄ± bilgisi kaydediliyor/getiriliyor.
			const LESSON_STORAGE_KEY = 'lessonName';
			const DEFAULT_LESSON_NAME = 'Matematik'; // VarsayÄ±lan deÄŸer
			
			// 1. KalÄ±cÄ± Veriyi YÃ¼kle veya VarsayÄ±lanÄ± Ata
			let lessonName = localStorage.getItem(LESSON_STORAGE_KEY);
			
			if (!lessonName) {
				 // Ä°lk defa aÃ§Ä±lÄ±yorsa varsayÄ±lanÄ± kullan ve kaydet
				 lessonName = DEFAULT_LESSON_NAME;
				 localStorage.setItem(LESSON_STORAGE_KEY, lessonName);
			}

            // YENÄ°: Kaydetme Bildirimini GÃ¶steren Fonksiyon
			function showSaveNotification(isError = false, message = 'Kaydedildi!') { // Ä°kinci parametreyi ekledik
				const notification = document.getElementById('saveNotification');
				
				notification.classList.remove('opacity-100', 'opacity-0', 'bg-green-500', 'bg-red-500');
				
				if (isError) {
					notification.classList.add('opacity-100', 'bg-red-500');
					notification.innerText = 'âŒ Hata: ' + message;
				} else {
					notification.classList.add('opacity-100', 'bg-green-500');
					notification.innerText = 'âœ“ ' + message;
				}
				
				setTimeout(() => {
					notification.classList.remove('opacity-100');
					notification.classList.add('opacity-0');
				}, 2500); // 2.5 saniye yapalÄ±m, mesajlar uzun olabilir
			}

			// KAYDETME FONKSÄ°YONUNU GÃœNCELLE
			function saveData(){ 
				localStorage.setItem('classes', JSON.stringify(classes));
				// Bildirim Ã§aÄŸÄ±rma artÄ±k dÄ±ÅŸarÄ±da olacak
			}
			// YENÄ°: StatÃ¼leri Kaydetme Fonksiyonu
			function saveStatuses() {
				saveData();
				showSaveNotification();
				
				document.querySelectorAll('.status.pending-change').forEach(cell => {
					// Kaydedildi: * iÅŸaretini ve vurguyu kaldÄ±r
					cell.classList.remove('pending-change');
					
					// KRÄ°TÄ°K DEÄÄ°ÅÄ°KLÄ°K: * iÅŸaretini metinden kaldÄ±r
					cell.innerText = cell.innerText.replace('*', ''); 

					const hwIndex = cell.dataset.hw;
					const studentIndex = cell.dataset.student;
					const newOriginalStatus = classes[currentClass].homeworks[hwIndex].statuses[studentIndex];
                    cell.dataset.originalStatus = newOriginalStatus;

				});
				
				// Kaydetme butonunu gizle
				document.getElementById('btnSaveStatuses').classList.add('hidden');
			}

            // TARÄ°H YARDIMCI FONKSÄ°YONLARI
            function getIsoDate(date) {
                return date.toISOString().split('T')[0];
            }

            const monthNames = ["Oca", "Åub", "Mar", "Nis", "May", "Haz", "Tem", "AÄŸu", "Eyl", "Eki", "Kas", "Ara"];
            const dayNames = ["Paz", "Pzt", "Sal", "Ã‡ar", "Per", "Cum", "Cmt"];


            function updateClassSelect(selectValue){
                // ... (SÄ±nÄ±f SeÃ§im MantÄ±ÄŸÄ±) ...
                const select = document.getElementById('classSelect');
                const prev = selectValue !== undefined ? selectValue : select.value;
                
                select.innerHTML = '<option value="">SÄ±nÄ±f SeÃ§iniz</option>' + Object.keys(classes).map(cls=>`<option value="${cls}">${cls}</option>`).join('');
                
                if(prev && classes[prev]){
                    select.value = prev;
                    currentClass = prev;
                } else {
                    select.value = '';
                    currentClass = '';
                }
            }

            function renderTable(){
                const tbody=document.getElementById('homeworkBody');
                const thead=document.getElementById('tableHead');
                const display = document.getElementById('currentClassNameDisplay');
				
				const lessonName = localStorage.getItem(LESSON_STORAGE_KEY) || DEFAULT_LESSON_NAME;
                const tableHeaderArea = document.getElementById('tableHeaderArea');
                
                // Tabloyu her zaman temizle
                thead.innerHTML = '';
                tbody.innerHTML = ''; 

                // SÄ±nÄ±f SeÃ§ili DeÄŸilse BaÅŸlÄ±ÄŸÄ± GÃ¼ncelle ve Durdur
                if(!currentClass || !classes[currentClass]){
                    display.innerText = 'LÃ¼tfen Bir SÄ±nÄ±f SeÃ§in';
                    tableHeaderArea.classList.add('hidden'); 
                    return; 
                }
                
                // SÄ±nÄ±f SeÃ§ili Ä°se BaÅŸlÄ±ÄŸÄ± GÃ¼ncelle ve Tabloyu OluÅŸturmaya BaÅŸla
                tableHeaderArea.classList.remove('hidden');
                // ğŸ¯ KRÄ°TÄ°K GÃœNCELLEME: BaÅŸlÄ±ÄŸa Ders AdÄ± ve DÃ¼zenleme YeteneÄŸi Ekleme
				display.innerHTML = `
					${currentClass} SÄ±nÄ±fÄ± 
					<span id="editableLessonName" 
						contenteditable="false"
						title="Dersi deÄŸiÅŸtirmek iÃ§in Ã§ift tÄ±klayÄ±n."
						class="text-l text-blue-700 font-bold p-1 rounded cursor-pointer whitespace-nowrap
						focus:outline-none border border-transparent hover:bg-blue-50"
						  >${lessonName}</span> 
					Dersi Ã–dev Tablosu
				`;
				
				// Ders AdÄ± DÃ¼zenleme Olay Dinleyicilerini Ekle
				const editableSpan = document.getElementById('editableLessonName');
				if (editableSpan) {
					
					// Ã‡ift TÄ±klama/Odaklanma ile dÃ¼zenlemeye aÃ§
					editableSpan.addEventListener('dblclick', function() {
						// contenteditable'Ä± TRUE yap ve odaklan
						this.setAttribute('contenteditable', 'true');
						this.focus();
						document.getSelection().collapse(this, 1); // Ä°mleci sona taÅŸÄ±
						this.classList.remove('border-transparent');
						this.classList.add('border-blue-700');
					});
					
					// Odak kaybolduÄŸunda (kaydetme)
					editableSpan.addEventListener('blur', function() {
						const newLesson = this.textContent.trim() || DEFAULT_LESSON_NAME;
						localStorage.setItem(LESSON_STORAGE_KEY, newLesson); // KalÄ±cÄ± kaydet
						this.textContent = newLesson; // DeÄŸeri temizle
						
						// KRÄ°TÄ°K: contenteditable'Ä± FALSE yap ve tek tÄ±klamayÄ± engelle
						this.setAttribute('contenteditable', 'false');
						
						this.classList.remove('border-blue-700'); 
						this.classList.add('border-transparent');
						// Bildirim fonksiyonunuzu Ã§aÄŸÄ±rÄ±n
						if (typeof showSaveNotification === 'function') {
							showSaveNotification(false, "Ders adÄ± gÃ¼ncellendi.");
						}
					});

					// Enter tuÅŸu ile kaydetme
					editableSpan.addEventListener('keydown', function(e) {
						if (e.key === 'Enter') {
							e.preventDefault(); 
							this.blur(); 
						}
					});
				}
               
                
                // ... (Tablo BaÅŸlÄ±ÄŸÄ± OluÅŸturma MantÄ±ÄŸÄ±) ...
                const studentHeaders = classes[currentClass].students.map((s,i) => 
                    `<th class="px-2 py-3 text-xs font-semibold uppercase tracking-wider text-white bg-blue-700 cursor-pointer" data-index='${i}' title="Ã–ÄŸrenci adÄ±nÄ± dÃ¼zenlemek iÃ§in Ã§ift tÄ±klayÄ±n">${s}</th>`
                ).join('');
                
                thead.innerHTML = `
                    <tr>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">#</th>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">Kaynak</th>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">Konu</th>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">Sayfa</th>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">VeriliÅŸ T.</th>
                        <th class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-white">Kontrol T.</th>
                        ${studentHeaders}
                    </tr>
                `;


                // Tablo Ä°Ã§eriÄŸini OluÅŸtur
                classes[currentClass].homeworks.forEach((hw,hwIndex)=>{
                    const row=document.createElement('tr');
                    row.classList.add('hover:bg-gray-50');

                    // Tarih HÃ¼creleri iÃ§in INPUT alanÄ± oluÅŸturuldu
                    const givenDateInput = `<input type="text" readonly class="flatpickr-input" data-date-field="givenDate" data-hw='${hwIndex}' value="${formatDateTurkish(hw.givenDate) || ''}">`;
                    const checkDateInput = `<input type="text" readonly class="flatpickr-input" data-date-field="checkDate" data-hw='${hwIndex}' value="${formatDateTurkish(hw.checkDate) || ''}">`;


                    // Ã–dev Bilgileri SÃ¼tunlarÄ±
                    const hwCells = `
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${hwIndex+1}</td>
                        <td contenteditable class='editable px-2 py-2 whitespace-nowrap text-sm text-gray-700' data-field='source' data-index='${hwIndex}' data-type='text'>${hw.source || ''}</td>
                        <td contenteditable class='editable px-2 py-2 whitespace-nowrap text-sm text-gray-700' data-field='topic' data-index='${hwIndex}' data-type='text'>${hw.topic || ''}</td>
                        <td contenteditable class='editable px-2 py-2 whitespace-nowrap text-sm text-gray-700' data-field='pages' data-index='${hwIndex}' data-type='text'>${hw.pages || ''}</td>
                        
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-700 date-cell" data-field='givenDate' data-index='${hwIndex}'>${givenDateInput}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-700 date-cell" data-field='checkDate' data-index='${hwIndex}'>${checkDateInput}</td>
                    `;
                    
                    // Ã–ÄŸrenci Durum SÃ¼tunlarÄ±
                    const statusCells = hw.statuses.map((status,studentIndex) => 
                        `<td class="status-cell">
                            <div class="status ${status}" 
                                data-hw='${hwIndex}' 
                                data-student='${studentIndex}'
                                data-original-status='${status}'>
                                ${status}
                            </div>
                        </td>`
                    ).join('');

                    row.innerHTML = hwCells + statusCells;
                    tbody.appendChild(row);
                });


                // 1. DÃ¼z Metin AlanlarÄ± DÃ¼zenleme (Ã‡ift TÄ±klama)
                document.querySelectorAll('.editable').forEach(cell=>{
                    cell.setAttribute('contenteditable', 'false');

                    cell.removeEventListener('blur', cell._blurHandler);
                    cell.removeEventListener('keydown', cell._keyHandler);
                    cell.removeEventListener('dblclick', cell._dblclickHandler);

                    cell._blurHandler = function(){
                        const index = this.dataset.index;
                        const field = this.dataset.field;
                        classes[currentClass].homeworks[index][field] = this.innerText.trim();
                        saveData();
                        this.setAttribute('contenteditable', 'false');
                    };
                    
                    cell._keyHandler = function(e){
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.blur();
                        }
                    };
                    
                    cell._dblclickHandler = function(){
                        this.setAttribute('contenteditable', 'true');
                        this.focus();
						document.getSelection().collapse(this, 1); // ğŸ”¹ Ä°mleci sona taÅŸÄ±r
                    };

                    cell.addEventListener('blur', cell._blurHandler);
                    cell.addEventListener('keydown', cell._keyHandler);
                    cell.addEventListener('dblclick', cell._dblclickHandler); 
                });
                
                // 2. Durum DeÄŸiÅŸtirme (Ã‡ift TÄ±klama ve KalÄ±cÄ± Vurgu)
				document.querySelectorAll('.status').forEach(cell => {
					// Ã–nceki olay dinleyicilerini temizleyelim (Ä°ki tip dinleyiciyi de temizleyelim)
					cell.removeEventListener('click', cell._clickHandler);
					cell.removeEventListener('dblclick', cell._dblClickHandler); 

					// Tek tÄ±klama iÃ§in yeni dinleyiciyi tanÄ±mlayalÄ±m
					// document.querySelectorAll('.status').forEach(cell => { ... } dÃ¶ngÃ¼sÃ¼ iÃ§inde:
					cell._clickHandler = function() {
						
						// 1. DURUM DEÄÄ°ÅÄ°KLÄ°ÄÄ° MANTIÄI (AynÄ± KalÄ±r)
						const hwIndex = Number(this.dataset.hw);
						const studentIndex = Number(this.dataset.student);
						const oldStatus = classes[currentClass].homeworks[hwIndex].statuses[studentIndex];
						let newStatus = ''; 
						
						if (oldStatus === "") {
							newStatus = cycleStatuses[0]; 
						} else {
							let currentCycleIndex = cycleStatuses.indexOf(oldStatus);
							currentCycleIndex = (currentCycleIndex + 1) % cycleStatuses.length;
							newStatus = cycleStatuses[currentCycleIndex];
						}
						
						// KRÄ°TÄ°K DEÄÄ°ÅÄ°KLÄ°K: Kaydetmek yerine sadece veriyi gÃ¼ncelle
						classes[currentClass].homeworks[hwIndex].statuses[studentIndex] = newStatus;
						// saveData(); ARTIK BURADA YOK!

						// 2. VÄ°SUEL GÃœNCELLEME 
						if (oldStatus !== "") {
							this.classList.remove(oldStatus);
						}
						this.classList.add(newStatus);Â 
                        this.innerText = newStatus;
                        //DOM'dan kayÄ±tlÄ± deÄŸeri al
                        const originalStatus = this.dataset.originalStatus;

                        if(newStatus === originalStatus){
                            //durum orijinal deÄŸerine geri dÃ¶ndÃ¼: GÃ¶rseli temizle
                            this.classList.remove('pending-change');
                            this.innerText = newStatus; //YÄ±ldÄ±zÄ± kaldÄ±r
                        }else{
                            //durum kayÄ±tlÄ± deÄŸerden farklÄ± ise Vurgula
                            this.classList.add('pending-change');
                            //durum metnine yÄ±ldÄ±z(*) ekle tabi yoksa
                            if(!this.innerText.includes('*')){
                                this.innerText = newStatus + '*';
                            }
                        }


						// Kaydetme butonunu gÃ¶ster/gizle
                        const hasPendingChanges = document.querySelectorAll('.status.pending-change').length > 0;
                        if(hasPendingChanges){
                            document.getElementById('btnSaveStatuses').classList.remove('hidden');
                        } else{
                            document.getElementById('btnSaveStatuses').classList.add('hidden');
                        }		

					};
					
					cell.addEventListener('click', cell._clickHandler);
				});

                // 3. Ã–ÄŸrenci AdÄ± DÃ¼zenleme (Ã‡ift TÄ±klama)
                // ... (Ã–nceki mantÄ±k aynÄ± kalÄ±r) ...
                document.querySelectorAll('#tableHead th[data-index]').forEach(th=>{
                    th.removeEventListener('dblclick', th._dblHandler);
                    th._dblHandler = function(){
                        const index = Number(this.dataset.index);
                        const oldName = classes[currentClass].students[index];
                        const newName = prompt('Yeni Ã¶ÄŸrenci adÄ±:', oldName);
                        if(newName && newName.trim() !== oldName){
                            classes[currentClass].students[index] = newName.trim();
                            saveData(); renderTable();
                        }
                    };
                    th.addEventListener('dblclick', th._dblHandler);
                });
                
                // 4. Flatpickr (Tarih) Entegrasyonu
                document.querySelectorAll('.flatpickr-input').forEach(input => {
                    const hwIndex = Number(input.dataset.hw);
                    const field = input.dataset.dateField;
                    
                    // Flatpickr'Ä± baÅŸlat
                    flatpickr(input, {
                        locale: 'tr', // TÃ¼rkÃ§e dil
                        defaultDate: classes[currentClass].homeworks[hwIndex][field], // Mevcut ISO tarihi
                        dateFormat: "Y-m-d", // VeritabanÄ± (localStorage) formatÄ±
                        altInput: true,
                        altFormat: "j M. D", // GÃ¶rÃ¼nen format: 17 Tem. SalÄ±
                        
                        // Tarih seÃ§ildiÄŸinde
                        onClose: function(selectedDates, dateStr, instance) {
                            if (selectedDates.length > 0) {
                                // Yeni tarihi kaydet
                                classes[currentClass].homeworks[hwIndex][field] = dateStr;
                                saveData();
                                
                                // DOM'u manuel olarak gÃ¼ncelle (Flatpickr, altInput'u kullandÄ±ÄŸÄ± iÃ§in otomatik gÃ¼nceller)
                                // Not: Yine de tutarlÄ± olmak iÃ§in renderTable() Ã§aÄŸrÄ±labilir, ancak bu performansÄ± etkiler.
                                // Sadece bu hÃ¼crenin gÃ¼ncellenmesi yeterlidir.
                            }
                        }
                    });
                });

            }

            function loadClass(){
                currentClass = document.getElementById('classSelect').value;
                renderTable();
            }

            // ... (addClass, editClass, addStudent fonksiyonlarÄ± aynÄ± kalÄ±r) ...
            
            function addClass(){
                const nameInput = document.getElementById('newClassName');
                const name = nameInput.value.trim();
                if(!name){ alert('LÃ¼tfen bir sÄ±nÄ±f adÄ± girin.'); return; }
                if(!classes[name]){
                    classes[name] = { students: [], homeworks: [] };
                    updateClassSelect(name); 
                    document.getElementById('classSelect').value = name;
                    currentClass = name; 
                    renderTable(); saveData();
                } else {
                    alert(`'${name}' adÄ±nda bir sÄ±nÄ±f zaten mevcut.`);
                }
                nameInput.value = '';
            }
            
            function editClass(){
                if(!currentClass){ alert('Ã–nce dÃ¼zenlemek istediÄŸiniz sÄ±nÄ±fÄ± seÃ§in.'); return; }
                const newName = prompt('Yeni sÄ±nÄ±f adÄ±:', currentClass);
                if(newName && newName.trim() !== currentClass && !classes[newName.trim()]){
                    classes[newName.trim()] = classes[currentClass];
                    delete classes[currentClass];
                    updateClassSelect(newName.trim());
                    document.getElementById('classSelect').value = newName.trim();
                    currentClass = newName.trim();
                    saveData(); renderTable();
                } else if (newName && newName.trim() !== currentClass) {
                    alert(`'${newName.trim()}' adÄ±nda bir sÄ±nÄ±f zaten mevcut veya boÅŸ bir isim girdiniz.`);
                }
            }

            function addStudent(){
                if(!currentClass){ alert('Ã–nce Ã¶ÄŸrenci eklemek istediÄŸiniz sÄ±nÄ±fÄ± seÃ§in.'); return; }
                const nameInput = document.getElementById('newStudent');
                const name = nameInput.value.trim();
                
                if(!name){ alert('LÃ¼tfen bir Ã¶ÄŸrenci adÄ± girin.'); return; }
                
                if(!classes[currentClass].students.includes(name)){
                    classes[currentClass].students.push(name);
                    classes[currentClass].homeworks.forEach(hw => hw.statuses.push("")); 
                    saveData(); 
                    renderTable(); 
                } else {
                    alert(`'${name}' adlÄ± Ã¶ÄŸrenci zaten bu sÄ±nÄ±fta.`);
                }
                nameInput.value = '';
            }


            // Ã–dev Ekleme (BasitleÅŸtirildi: Tarih otomatik atanacak)
            function addHomework(){
                if(!currentClass){ alert('Ã–nce Ã¶dev eklemek istediÄŸiniz sÄ±nÄ±fÄ± seÃ§in.'); return; }
                
                const sourceInput = document.getElementById('source');
                const topicInput = document.getElementById('topic');
                const pagesInput = document.getElementById('pages');

                const source = sourceInput.value.trim();
                const topic = topicInput.value.trim();
                const pages = pagesInput.value.trim();
                
                if(!source || !topic || !pages){ alert('Kaynak, Konu ve Sayfa alanlarÄ±nÄ± doldurun.'); return; }
                
                // Tarihleri Otomatik Olarak Ata (BugÃ¼n ve 7 gÃ¼n sonrasÄ±)
                let givenDateObj = new Date();
                let givenDate = getIsoDate(givenDateObj);
                
                let checkDateObj = new Date(givenDateObj);
                checkDateObj.setDate(givenDateObj.getDate() + 7);
                let checkDate = getIsoDate(checkDateObj);
                
                const hw = { 
                    source, 
                    topic, 
                    pages, 
                    givenDate, // ISO formatÄ±nda sakla
                    checkDate, // ISO formatÄ±nda sakla
                    statuses: classes[currentClass].students.map(()=> "") 
                };
                
                classes[currentClass].homeworks.push(hw);
                saveData(); 
                renderTable(); 
                
                // Form alanlarÄ±nÄ± temizle
                sourceInput.value = '';
                topicInput.value = '';
                pagesInput.value = '';
            }
            
			// exportJSON fonksiyonu
			function exportAllData() {
				// 1ï¸âƒ£ KaydedilmiÅŸ sÄ±nÄ±f verisi var mÄ± kontrol et
				if (!classes || !Object.keys(classes).length) {
					alert('KaydedilmiÅŸ sÄ±nÄ±f verisi bulunmamaktadÄ±r.');
					return;
				}

			try {
				// 2ï¸âƒ£ JSON verisini oluÅŸtur
				const jsonData = JSON.stringify(classes, null, 2);

				// 3ï¸âƒ£ Blob nesnesi oluÅŸtur (gerÃ§ek dosya gibi davranÄ±r)
				const blob = new Blob([jsonData], { type: "application/json;charset=utf-8" });

				// 4ï¸âƒ£ Blob iÃ§in geÃ§ici bir URL oluÅŸtur
				const url = URL.createObjectURL(blob);

				// 5ï¸âƒ£ <a> etiketiyle indirme iÅŸlemini baÅŸlat
				const dl = document.createElement('a');
				dl.href = url;
				dl.download = 'odev_takip_yedek_' + new Date().toISOString().split('T')[0] + '.json';

				document.body.appendChild(dl);
				dl.click(); // otomatik indir
				document.body.removeChild(dl);

				// 6ï¸âƒ£ Bellek temizliÄŸi (Blob URLâ€™ini serbest bÄ±rak)
				URL.revokeObjectURL(url);

				// 7ï¸âƒ£ KullanÄ±cÄ±ya bilgi ver
				if (typeof showSaveNotification === "function") {
					showSaveNotification(false, "Verileriniz baÅŸarÄ±yla yedeklendi");
				} else {
					alert("Verileriniz baÅŸarÄ±yla yedeklendi");
				}

			} catch (err) {
				console.error("Yedekleme sÄ±rasÄ±nda hata oluÅŸtu:", err);
				alert("Bir hata oluÅŸtu, yedekleme baÅŸarÄ±sÄ±z oldu. TarayÄ±cÄ±nÄ±zÄ± yeniden deneyin.");
			}
			}
			function formatDateTurkish(isoDate) {
				if (!isoDate) return '';
				
				// YYYY-MM-DD formatÄ±ndaki tarihi Date nesnesine Ã§evir
				const parts = isoDate.split('-');
				// Not: Ay indeksi 0'dan baÅŸlar (parts[1] - 1)
				const date = new Date(parts[0], parts[1] - 1, parts[2]);

				const options = { 
					day: 'numeric',   // GÃ¼nÃ¼ sayÄ± olarak (15)
					month: 'long',    // Ay ismini tam olarak (Ekim)
					weekday: 'long'   // HaftanÄ±n gÃ¼nÃ¼nÃ¼ tam olarak (Ã‡arÅŸamba)
				};
				
				// 'tr-TR' dilini kullanarak formatla
				const formattedDate = date.toLocaleDateString('tr-TR', options);
				
				// toLocaleDateString, genellikle "GG.AY.YYYY" gibi bir format verir.
				// Bizim istediÄŸimiz: "15 Ekim Ã‡arÅŸamba"
				
				// Bu formatÄ± elde etmek iÃ§in daha spesifik bir ayar kullanalÄ±m
				const day = date.getDate();
				const month = date.toLocaleDateString('tr-TR', { month: 'long' });
				const weekday = date.toLocaleDateString('tr-TR', { weekday: 'long' });

				// Ä°stediÄŸiniz virgÃ¼lsÃ¼z formatÄ± boÅŸluklarla birleÅŸtirir
				return `${day} ${month} ${weekday}`;
				// Ã‡Ä±ktÄ± Ã–rn: 15 Ekim Ã‡arÅŸamba
			}
            function exportCSV() {
				if (!currentClass) {
					alert('LÃ¼tfen Ã¶nce dÄ±ÅŸa aktarmak istediÄŸiniz sÄ±nÄ±fÄ± seÃ§in.');
					return;
				}

				// UTF-8 BOM: TÃ¼rkÃ§e karakterlerin Excelâ€™de dÃ¼zgÃ¼n gÃ¶rÃ¼nmesi iÃ§in
				const BOM = "\uFEFF";

				const header = [
					'#',
					'Kaynak',
					'Konu',
					'Sayfa',
					'VeriliÅŸ T.',
					'Kontrol T.',
					...classes[currentClass].students
				];

				const rows = classes[currentClass].homeworks.map((hw, idx) => {
					const pagesValue =
						(hw.pages || '').includes('-') || (hw.pages || '').includes('/')
							? "'" + hw.pages
							: hw.pages;

					return [
						idx + 1,
						hw.source,
						hw.topic,
						pagesValue,
						formatDateTurkish(hw.givenDate), // VeriliÅŸ Tarihi
						formatDateTurkish(hw.checkDate), // Kontrol Tarihi
						...hw.statuses
					];
				});

				// CSV iÃ§in gÃ¼venli deÄŸer dÃ¶nÃ¼ÅŸÃ¼mÃ¼
				const cleanAndQuote = (val) => {
					if (val === null || val === undefined) return '';
					const strVal = String(val).replace(/\n/g, ' ').trim();
					return `"${strVal.replace(/"/g, '""')}"`;
				};

				// âœ… 1. SatÄ±r: SINIF baÅŸlÄ±ÄŸÄ± (tÃ¼m sÃ¼tun sayÄ±sÄ±na gÃ¶re doÄŸru ÅŸekilde oluÅŸturulur)
				const classTitleRow = [
					`SINIF: ${currentClass}`,
					...new Array(header.length - 1).fill('')
				].map(cleanAndQuote).join(';');

				// âœ… 2. SatÄ±r: SÃ¼tun baÅŸlÄ±klarÄ± + 3. ve sonraki satÄ±rlar: Ã¶devler
				const csv = [
					classTitleRow,
					header.map(cleanAndQuote).join(';'),
					...rows.map(r => r.map(cleanAndQuote).join(';'))
				].join('\n');

				// âœ… CSV dosyasÄ±nÄ± oluÅŸtur ve indir
				const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
				const url = URL.createObjectURL(blob);

				const dl = document.createElement('a');
				dl.href = url;
				dl.download = `${currentClass}_odev_takip_${new Date()
					.toISOString()
					.split('T')[0]}.csv`;

				document.body.appendChild(dl);
				dl.click();
				document.body.removeChild(dl);
				URL.revokeObjectURL(url);
			}

			function importData(event) {
			  const file = event.target.files[0];
			  if (!file) return;

			  const reader = new FileReader();

			  reader.onload = (e) => {
				try {
				  const data = JSON.parse(e.target.result);

				  // 1ï¸âƒ£ JSON geÃ§erli mi ve beklenen yapÄ±da mÄ±?
				  if (!data || typeof data !== 'object' || Array.isArray(data)) {
					alert("âŒ GeÃ§ersiz dosya yapÄ±sÄ±: Bir 'Ã¶dev takip dosyasÄ±' JSON'u bekleniyor.");
					event.target.value = '';
					return;
				  }

				  const hasValidStructure = Object.values(data).every(
					cls => typeof cls === 'object' && !Array.isArray(cls)
				  );

				  if (!hasValidStructure) {
					alert("âŒ GeÃ§ersiz iÃ§erik: Dosya 'Ã¶dev takip dosyasÄ±' iÃ§ermiyor.");
					event.target.value = '';
					return;
				  }

				  // 2ï¸âƒ£ JSON doÄŸruysa, ÅŸimdi kullanÄ±cÄ±dan onay iste
				  const isConfirmed = confirm("ğŸ“¦ Yedekten veri yÃ¼klenecek.\n\n" +
					"Bu iÅŸlem mevcut SINIF ve Ã–DEV verilerinizi yedekteki verilerle deÄŸiÅŸtirecektir.\n" +
					"EÄŸer mevcut verilerinizi korumak istiyorsanÄ±z, lÃ¼tfen Ã¶nce yedek alÄ±n.\n" +
					"Devam etmek istiyor musunuz?");
				  if (!isConfirmed) {
					event.target.value = '';
					return;
				  }

				  // 3ï¸âƒ£ Onay verildiyse veriyi kaydet
				  localStorage.setItem('classes', JSON.stringify(data));
				  classes = data;

				  updateClassSelect();

				  const firstClass = Object.keys(classes)[0];
				  if (firstClass) {
					document.getElementById('classSelect').value = firstClass;
					currentClass = firstClass;
				  }

				  renderTable();
				  showSaveNotification(false, "âœ… Veriler baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±.");
				} 
				catch (err) {
				  console.error("Ä°Ã§e aktarma hatasÄ±:", err);
				  alert("âŒ Hata: Dosya JSON formatÄ±nda deÄŸil.");
				}

				event.target.value = ''; // input temizle
			  };

			  reader.readAsText(file);
			}



            // Olay Dinleyicileri
            document.getElementById('btnAddClass').addEventListener('click', addClass);
            document.getElementById('btnEditClass').addEventListener('click', editClass);
            document.getElementById('btnAddStudent').addEventListener('click', addStudent);
            document.getElementById('btnAddHomework').addEventListener('click', addHomework);
            document.getElementById('btnExportJSON').addEventListener('click', exportAllData);
			
			document.getElementById('btnImportJSONTrigger').addEventListener('click', () => {
				document.getElementById('fileImport').click(); // Gizli input'u tetikle
				});
			// Dosya seÃ§ildiÄŸinde iÃ§e aktarma fonksiyonunu Ã§alÄ±ÅŸtÄ±r:
			document.getElementById('fileImport').addEventListener('change', importData);
			
            document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
            document.getElementById('classSelect').addEventListener('change', loadClass);
			
			document.getElementById('btnSaveStatuses').addEventListener('click', saveStatuses)
			
			// Olay Dinleyicileri bloÄŸuna ekleyin:
			document.getElementById('btnShareToParent').addEventListener('click', shareTableAsImage);
			
			
            // BaÅŸlangÄ±Ã§ MantÄ±ÄŸÄ±
            updateClassSelect();
            if(currentClass) loadClass(); else renderTable();
        });
		
		// JavaScript <script> bloÄŸunda, mevcut fonksiyonlarÄ±nÄ±zÄ±n arasÄ±na ekleyin:

		// GÃœNCELLENMÄ°Å shareTableAsImage FONKSÄ°YONU
		async function shareTableAsImage() {
			if (!currentClass) {
				// Hata yÃ¶netimi aynÄ± kalÄ±r...
				return;
			}
			
			const shareButton = document.getElementById('btnShareToParent');
			const originalText = shareButton.innerHTML;
			shareButton.innerHTML = 'ğŸ“¸&nbsp;HazÄ±rlanÄ±yor...';
			shareButton.disabled = true;

			const tableContainer = document.getElementById('tableContainer'); // Ana KapsayÄ±cÄ± (GÃ¶rÃ¼ntÃ¼lenen Alan)
			if (!tableContainer) {
				// Hata yÃ¶netimi aynÄ± kalÄ±r...
				return;
			}
			
			// Gerekli ElemanlarÄ± SeÃ§me
			const tableElement = document.getElementById('homeworkTable'); // Tablonun Kendisi
			const tableDiv = tableContainer.querySelector('.overflow-x-auto');
			const headerArea = document.getElementById('tableHeaderArea'); // BaÅŸlÄ±k ve ButonlarÄ± Saran Alan
			const currentClassNameArea = document.getElementById('currentClassNameDisplay'); // H2 BaÅŸlÄ±ÄŸÄ±
			const headerDiv = headerArea.querySelector('.flex.gap-3.items-center'); // ButonlarÄ± saran Flex div
			const exportCSVButton = document.getElementById('btnExportCSV');

			// --- 1. Orijinal CSS Yedeklerini Saklama (Temizlik iÃ§in KRÄ°TÄ°K) ---
			
			const originalOverflow = tableDiv ? tableDiv.style.overflowX : '';
			const originalContainerPadding = tableContainer.style.padding;
			const originalContainerMargin = tableContainer.style.margin;
			
			// KRÄ°TÄ°K YENÄ° YEDEK: tableContainer'Ä±n orijinal geniÅŸliÄŸini sakla
			const originalContainerWidth = tableContainer.style.width; 
			
			// BaÅŸlÄ±k alanÄ±nÄ±n ve butonlarÄ±n orijinal stillerini sakla
			const originalCurrentClassNameWhitespace = currentClassNameArea ? currentClassNameArea.style.whiteSpace : '';
			const originalHeaderDisplay = headerDiv ? headerDiv.style.display : '';
			const shareButtonDisplay = shareButton.style.display;
			const exportCSVDisplay = exportCSVButton ? exportCSVButton.style.display : '';
			
			// --- 2. GÃ¶rÃ¼ntÃ¼ Ã–ncesi GeÃ§ici CSS DeÄŸiÅŸiklikleri ---

			// ButonlarÄ± gizle ve Header'daki flex dÃ¼zenini boz
			shareButton.style.display = 'none';
			if(exportCSVButton) exportCSVButton.style.display = 'none';
			if (headerDiv) headerDiv.style.display = 'block';

			// *** KRÄ°TÄ°K GENÄ°ÅLÄ°K Ã‡Ã–ZÃœMÃœ: tableContainer'i tablonun geniÅŸliÄŸine zorla ***
			if (tableElement) {
				// Ana kapsayÄ±cÄ±nÄ±n geniÅŸliÄŸini, tablonun gerÃ§ek (kaydÄ±rÄ±lmamÄ±ÅŸ) geniÅŸliÄŸine eÅŸitle
				tableContainer.style.width = tableElement.scrollWidth + 'px';
				// Tablo baÅŸlÄ±k alanÄ±nÄ±n da geniÅŸliÄŸini eÅŸitlemek, boÅŸluk kalmasÄ±nÄ± engeller
				headerArea.style.width = tableElement.scrollWidth +  'px';
			}
 

			// DiÄŸer Layout DÃ¼zeltmeleri
			if (tableDiv) {
				tableDiv.style.overflowX = 'visible'; // KaydÄ±rmayÄ± kapat
				tableDiv.style.width = 'auto';
				tableDiv.style.maxWidth = 'none';
			}
 
			tableContainer.style.padding = '5px';
			tableContainer.style.margin = '5px auto';
			tableContainer.style.backgroundColor = '#ffffff';
			if (currentClassNameArea) currentClassNameArea.style.whiteSpace = 'nowrap'; // BaÅŸlÄ±k metnini tek satÄ±ra zorla

			// DÃ¼zenlenebilir alanlarÄ±n focus durumunu kaldÄ±r
			document.querySelectorAll('[contenteditable="true"]').forEach(el => el.blur());


			// --- 3. dom-to-image Ã§aÄŸrÄ±sÄ± ---
			await new Promise(r => setTimeout(r, 100));
			domtoimage.toPng(tableContainer, {
				bgcolor: '#ffffff',
				// GeniÅŸliÄŸi CSS ile ayarladÄ±ÄŸÄ±mÄ±z iÃ§in, offsetWidth kullanmak yeterlidir.
				width: tableContainer.scrollWidth, 
				height: tableContainer.scrollHeight,
			})
			.then(async function (dataUrl) {
		
				// GÃ¶rÃ¼ntÃ¼ DosyasÄ±nÄ±n AdÄ±
				const filename = `${currentClass}_odev_tablo_${new Date().toISOString().split('T')[0]}.png`;

				// Mobil PaylaÅŸÄ±m KontrolÃ¼ (Web Share API)
				if (navigator.share && navigator.canShare && dataUrl) {
					
					// Data URL'yi Blob nesnesine dÃ¶nÃ¼ÅŸtÃ¼rme
					const blob = await (await fetch(dataUrl)).blob();
					const file = new File([blob], filename, { type: 'image/png' });

					try {
						await navigator.share({
							files: [file],
							title: 'SÄ±nÄ±f Ã–dev Tablosu',
							text: `${currentClass} SÄ±nÄ±fÄ± iÃ§in Ã¶dev tablosu gÃ¶rselini paylaÅŸÄ±yorum.`,
						});
						showSaveNotification(false, "Tablo resmi baÅŸarÄ±yla paylaÅŸÄ±ldÄ±!");
						
					} catch (error) {
						if (error.name !== 'AbortError') {
							console.error('Web Share API hatasÄ±:', error);
							showSaveNotification(true, "PaylaÅŸÄ±m baÅŸlatÄ±lÄ±rken bir sorun oluÅŸtu.");
						}
					}
					
				} else {
					// MasaÃ¼stÃ¼ DesteÄŸi (Ä°ndirme)
					const dl = document.createElement('a');
					dl.href = dataUrl;
					dl.download = filename;

					document.body.appendChild(dl);
					dl.click();
					document.body.removeChild(dl);
					
					showSaveNotification(false, "Tablo resmi cihazÄ±nÄ±za indirildi. Åimdi paylaÅŸabilirsiniz!");
				}
			})
			.catch(function (error) {
				showSaveNotification(true, "GÃ¶rsel oluÅŸturulurken bir hata oluÅŸtu: " + error.message);
			})
			.finally(() => {
				// --- 4. TEMÄ°ZLÄ°K: TÃœM GEÃ‡Ä°CÄ° DEÄÄ°ÅÄ°KLÄ°KLERÄ° GERÄ° AL ---
				
				// KRÄ°TÄ°K: GeniÅŸliÄŸi geri yÃ¼kle
				tableContainer.style.width = originalContainerWidth;
				headerArea.style.width = ''; // Header geniÅŸliÄŸini kaldÄ±r

				// DiÄŸer Layout Geri YÃ¼klemeleri
				tableContainer.style.margin = originalContainerMargin;
				tableContainer.style.padding = originalContainerPadding;
				tableContainer.style.backgroundColor = '';

				// ButonlarÄ± ve Layout'u geri getir
				shareButton.style.display = shareButtonDisplay;
				if(exportCSVButton) exportCSVButton.style.display = exportCSVDisplay;
				if (headerDiv) headerDiv.style.display = originalHeaderDisplay;
				if (currentClassNameArea) currentClassNameArea.style.whiteSpace = originalCurrentClassNameWhitespace;
				if (tableDiv) tableDiv.style.overflowX = originalOverflow;
				
				// Butonu sÄ±fÄ±rla
				shareButton.innerHTML = originalText;
				shareButton.disabled = false;
			});
		}
    </script>

</body>
</html>


